version: 2
jobs:
  build:
    docker:
      - image: circleci/golang:1.12
    environment:
      GO111MODULE: "on"
    steps: # steps that comprise the `build` job
      - checkout # check out source code to working directory
      - setup_remote_docker # allows running docker commands
      - restore_cache: # restores saved cache if no changes are detected since last run
          keys:
            - go-mod-cache
      - run:
          name: Install go tools
          command: |
            make setup-env
      - run:
          name: Print env
          command: make env
      - run:
          name: Verify formatting
          command: make fmt lint
      - run:
          name: Run unit tests
          command: make test
      - save_cache: # Store cache in the /go/pkg directory
          key: go-mod-cache
          paths:
            - "/go/pkg/mod"
